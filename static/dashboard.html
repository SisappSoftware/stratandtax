<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Dashboard | Strat & Tax</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Base CSS -->
  <link rel="stylesheet" href="style2.css">

  <style>
    :root {
      --bg:#0b1020;
      --panel:#0f172a;
      --card:rgba(255,255,255,.06);
      --primary:#6366f1;
      --muted:#94a3b8;
      --radius:18px;
    }

    * { box-sizing:border-box; }
    body { margin:0; background:var(--bg); font-family:Inter,sans-serif; color:white; }

    /* ===== Layout ===== */
    .app {
      display:grid;
      grid-template-columns:260px 1fr;
      min-height:100vh;
    }

    /* ===== Sidebar ===== */
    .sidebar {
      background:linear-gradient(180deg,#0c122c,#070b1a);
      padding:28px 22px;
      display:flex;
      flex-direction:column;
      gap:28px;
      border-right:1px solid rgba(255,255,255,.05);
    }

    .brand {
      font-weight:800;
      letter-spacing:.5px;
      font-size:18px;
    }

    .nav {
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .nav-item {
      padding:12px 14px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:center;
      color:#c7d2fe;
      transition:.2s;
    }

    .nav-item:hover {
      background:rgba(99,102,241,.12);
    }

    .nav-item.active {
      background:linear-gradient(135deg,#6366f1,#818cf8);
      color:white;
      box-shadow:0 10px 30px rgba(99,102,241,.35);
    }

    .sidebar-footer {
      margin-top:auto;
      font-size:13px;
      color:var(--muted);
    }

    .logout {
      color:#fca5a5;
      cursor:pointer;
      margin-top:10px;
    }

    /* ===== Main ===== */
    .main {
      padding:40px;
    }

    .container {
      max-width:1200px;
      margin:0 auto;
    }

    .header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:32px;
    }

    .header h1 {
      font-size:28px;
      font-weight:800;
    }

    .user-pill {
      background:rgba(255,255,255,.06);
      padding:8px 14px;
      border-radius:999px;
      font-size:14px;
    }

    /* ===== Cards ===== */
    .cards {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:22px;
    }

    .card {
      background:linear-gradient(180deg,rgba(255,255,255,.09),rgba(255,255,255,.03));
      border-radius:var(--radius);
      padding:26px;
      transition:.25s;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
    }

    .card:hover {
      transform:translateY(-4px);
      box-shadow:0 30px 80px rgba(0,0,0,.45);
    }

    .card h3 { margin:0 0 8px; }
    .muted { color:var(--muted); }

    /* ===== Buttons ===== */
    .btn {
      background:linear-gradient(135deg,#6366f1,#818cf8);
      color:white;
      border:none;
      padding:10px 18px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      margin-top:14px;
    }

    .btn:disabled {
      opacity:.6;
      cursor:not-allowed;
    }

    /* ===== Forms ===== */
    .input, textarea {
      width:100%;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:12px 14px;
      color:white;
      margin-bottom:14px;
    }

    label {
      font-size:13px;
      color:var(--muted);
      margin-bottom:6px;
      display:block;
    }

    /* ===== Table ===== */
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
    }

    th,td {
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:14px;
    }

    th { color:#c7d2fe; text-align:left; }

    /* ===== Toast ===== */
    .toast {
      position:fixed;
      bottom:30px;
      right:30px;
      background:#111827;
      padding:14px 20px;
      border-radius:12px;
      opacity:0;
      transition:.3s;
      box-shadow:0 20px 50px rgba(0,0,0,.5);
    }

    .toast.show { opacity:1; }

    /* ===== Responsive ===== */
    @media(max-width:900px){
      .app { grid-template-columns:1fr; }
      .sidebar { position:fixed; left:-100%; }
      .main { padding:24px; }
    }
  </style>
</head>

<body>

<script>
const token = localStorage.getItem("token");
if (!token) location.href="login.html";
</script>

<div class="app">

  <aside class="sidebar">
    <div class="brand">STRAT & TAX</div>

    <div class="nav" id="nav">
      <div class="nav-item active" data-view="home">üè† Inicio</div>
      <div class="nav-item" data-view="forms">üìù Formularios</div>
      <div class="nav-item" data-view="docs">üìÑ Mis documentos</div>
    </div>

    <div class="sidebar-footer">
      <div id="userEmail"></div>
      <div class="logout" onclick="logout()">Cerrar sesi√≥n</div>
    </div>
  </aside>

  <main class="main">
    <div class="container">
      <div class="header">
        <h1 id="title">Dashboard</h1>
        <div class="user-pill" id="userRole"></div>
      </div>
      <div id="content"></div>
    </div>
  </main>

</div>

<div class="toast" id="toast"></div>

<script>
let USER=null;

fetch("/auth/me",{headers:{Authorization:"Bearer "+token}})
.then(r=>r.json())
.then(u=>{
  USER=u;
  document.getElementById("userEmail").textContent=u.email;
  document.getElementById("userRole").textContent=u.role.toUpperCase();
  loadHome();
});

document.getElementById("nav").onclick=e=>{
  const i=e.target.closest(".nav-item");
  if(!i)return;
  document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));
  i.classList.add("active");
  if(i.dataset.view==="home")loadHome();
  if(i.dataset.view==="forms")loadForms();
  if(i.dataset.view==="docs")loadDocs();
};

function setTitle(t){document.getElementById("title").textContent=t;}

function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),3000);
}

/* ===== Views ===== */
function loadHome(){
  setTitle("Inicio");
  content.innerHTML=`
    <div class="cards">
      <div class="card"><h3>Usuario</h3><p class="muted">${USER.email}</p></div>
      <div class="card"><h3>Rol</h3><p class="muted">${USER.role}</p></div>
      <div class="card"><h3>Estado</h3><p class="muted">Cuenta activa</p></div>
    </div>
  `;
}

function loadForms(){
  setTitle("Formularios");
  fetch("/client/forms",{headers:{Authorization:"Bearer "+token}})
  .then(r=>r.json())
  .then(fs=>{
    content.innerHTML=`<div class="cards">${
      fs.map(f=>`
        <div class="card">
          <h3>${f.label}</h3>
          <p class="muted">${f.description||""}</p>
          <button class="btn" onclick="openForm('${f.id}')">Completar</button>
        </div>
      `).join("")
    }</div>`;
  });
}

function openForm(id){
  fetch(`/client/forms/${id}`,{headers:{Authorization:"Bearer "+token}})
  .then(r=>r.json())
  .then(s=>{
    setTitle(s.label);
    content.innerHTML=`
      <div class="card">
        <form id="form">
          ${s.fields.map(f=>`
            <label>${f.label}</label>
            ${f.type==="textarea"
              ? `<textarea name="${f.key}"></textarea>`
              : `<input class="input" type="${f.type||"text"}" name="${f.key}">`
            }
          `).join("")}
          <button class="btn">Generar documento</button>
        </form>
      </div>
    `;
    document.getElementById("form").onsubmit=e=>{
      e.preventDefault();
      const data={};
      new FormData(e.target).forEach((v,k)=>data[k]=v);
      generate(id,data,e.target.querySelector("button"));
    };
  });
}

function generate(id,data,btn){
  btn.disabled=true;
  btn.textContent="Generando...";
  fetch("/client/generate",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:"Bearer "+token
    },
    body:JSON.stringify({template_type:id,data,output_prefix:id})
  })
  .then(r=>r.json())
  .then(()=>{
    toast("Documento generado");
    loadDocs();
  });
}

function loadDocs(){
  setTitle("Mis documentos");
  fetch("/client/documents",{headers:{Authorization:"Bearer "+token}})
  .then(r=>r.json())
  .then(ds=>{
    content.innerHTML=`
      <div class="card">
        <table>
          <tr><th>Fecha</th><th>Tr√°mite</th><th>Archivo</th></tr>
          ${ds.map(d=>`
            <tr>
              <td>${d.created_at}</td>
              <td>${d.template_type}</td>
              <td><a href="/download/${d.filename}">Descargar</a></td>
            </tr>
          `).join("")}
        </table>
      </div>
    `;
  });
}

function logout(){
  localStorage.removeItem("token");
  location.href="login.html";
}
</script>

</body>
</html>
